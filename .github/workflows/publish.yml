name: Npm Publish

on:
  push:
    branches:
      - master
    paths:
      - 'packages/rule/package.json'
      - 'packages/config/package.json'

permissions:
  id-token: write
  contents: read

jobs:
  check-commit:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message and author
        id: check
        run: |
          # Get the latest commit message and author email
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=%ae)

          echo "Commit message: $COMMIT_MSG"
          echo "Commit author email: $COMMIT_AUTHOR_EMAIL"

          # Check if commit message starts with "chore: upgrade packages version"
          if [[ "$COMMIT_MSG" == "chore: upgrade packages version"* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Matched: commit message starts with 'chore: upgrade packages version'"
            exit 0
          fi

          # Check if commit author is dev@jshow.org
          if [ "$COMMIT_AUTHOR_EMAIL" != "dev@jshow.org" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Matched: commit author is dev@jshow.org"
            exit 0
          fi

          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "Skipping CI: commit message does not start with 'chore: upgrade packages version' and author is not dev@jshow.org"

  build-publish:
    runs-on: ubuntu-latest
    needs: check-commit
    if: needs.check-commit.outputs.should_run == 'true'
    outputs:
      check_config: ${{ steps.check_config.outputs.modified }}
      check_rule: ${{ steps.check_rule.outputs.modified }}
      config_version: ${{ steps.build_config.outputs.version }}
      rule_version: ${{ steps.build_rule.outputs.version }}
      config_published: ${{ steps.build_config.outputs.version != '' }}
      rule_published: ${{ steps.build_rule.outputs.version != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'
        # env:
        #   NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Get last commit
        id: last_commit
        run: |
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            echo "sha=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
          else
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # ========================================

      - name: Check for changes in packages/rule
        id: check_rule
        run: |
          COUNT=$(git diff --name-only ${{ steps.last_commit.outputs.sha }} ${{ github.sha }} -- packages/rule 2>/dev/null | wc -l | tr -d ' ')
          echo "modified=$COUNT" >> $GITHUB_OUTPUT

      - name: Check for changes in packages/config
        id: check_config
        run: |
          COUNT=$(git diff --name-only ${{ steps.last_commit.outputs.sha }} ${{ github.sha }} -- packages/config 2>/dev/null | wc -l | tr -d ' ')
          echo "modified=$COUNT" >> $GITHUB_OUTPUT

      # ========================================

      - name: Install Dependencies & Cleanup dist
        if: steps.check_config.outputs.modified != '0' || steps.check_rule.outputs.modified != '0'
        run: |
          # 删除可能干扰认证的 .npmrc 文件
          rm -rf ./.npmrc ~/.npmrc
          npm install -g npm@latest
          pnpm install --no-frozen-lockfile
          pnpm clean

      # ========================================

      - name: Build packages/rule
        if: steps.check_rule.outputs.modified != '0'
        id: build_rule
        run: |
          node ./scripts/npm-publish.js -p rule
          VERSION=$(node -p "require('./packages/rule/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          pnpm build:rule

      - name: Publish eslint-plugin-jshow
        if: steps.build_rule.outputs.version != ''
        id: publish_rule
        run: |
          cd packages/rule
          npm publish --access public
          echo "published=true" >> $GITHUB_OUTPUT
          cd ../..

      # ========================================

      - name: Build packages/config
        if: steps.check_config.outputs.modified != '0'
        id: build_config
        run: |
          node ./scripts/npm-publish.js -p config
          VERSION=$(node -p "require('./packages/config/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          pnpm build:config

      - name: Publish eslint-config-jshow
        if: steps.build_config.outputs.version != ''
        id: publish_config
        run: |
          cd packages/config
          npm publish --access public
          echo "published=true" >> $GITHUB_OUTPUT
          cd ../..
